name: Deploy Node.js App to Alibaba Cloud ECS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}   # åº”è®¾ä¸º 'deploy'
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

            echo "ğŸ”§ è¿›å…¥é¡¹ç›®ç›®å½•..."
            cd /home/deploy/videotc

            echo "ğŸ”„ æ‹‰å–æœ€æ–°ä»£ç ..."
            git reset --hard
            git pull origin main

            echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
            cd VTC-Web1.0
            npm install --production

            echo "ğŸ¨ æ„å»ºå‰ç«¯èµ„æº..."
            cd ../VTC-Web1.0-UI
            npm install
            npm run build

            echo "ğŸ“‚ å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©åˆ°åç«¯ public ç›®å½•..."
            # å‡è®¾å‰ç«¯ build è¾“å‡ºåˆ° dist/ï¼Œåç«¯é™æ€æ–‡ä»¶ç›®å½•æ˜¯ ../VTC-Web1.0/public
            mkdir -p ../VTC-Web1.0/public
            cp -r dist/* ../VTC-Web1.0/public/

            echo "ğŸ” é‡å¯ PM2 æœåŠ¡..."
            cd ../VTC-Web1.0
            pm2 restart videotc || pm2 start app.js --name "videotc"

            echo "âœ… éƒ¨ç½²æˆåŠŸï¼æœåŠ¡å·²æ›´æ–°å¹¶é‡å¯ã€‚"
